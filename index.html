<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Image Converter</title>
    <style>
        body {
            background-color: rgb(105, 105, 105);
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        #butt:hover{
            background-color: rgb(90, 90, 90);
        }
        #butt{
            border-radius: 5px;
            cursor: pointer;
            background-color: rgb(70, 70, 70);
            font-size: 90px; 
        }
        
        .parent {
            display: flex;
            
            justify-content: center;
            flex-direction: column
            
        }
        .ahahaa {
            font-size :30px;
        }
        #imageContainer img {
            display: flex;
            flex-direction: column;
            max-width: 100%;
            height: auto;
            margin-top: 20px;
        }
    </style>

</head>

<body>
    
    <p>
    <label id="butt" class="parent" for="pdfInput">選擇pdf檔案</label>
    <input id="pdfInput"  type="file" accept=".pdf" style="visibility: hidden;" />
    </p>

    <div class="parent" id="result" style="font-size: 50px; " alt="使用圖片" title="被偵測圖片">文檔辨識</div>

    <div id="imageContainer" class="parent"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>



    <script>
        const resultDiv = document.getElementById('result');
        

        document.getElementById('pdfInput').addEventListener('change', async function (event) {
            const file = event.target.files[0];
            if (file) {
                const pdfData = await file.arrayBuffer();
                const loadingTask = pdfjsLib.getDocument({ data: pdfData });

                loadingTask.promise.then(async function (pdf) {
                    resultDiv.textContent="處理中..."
                    const numPages = pdf.numPages; // Get the total number of pages in the PDF

                    const imageContainer = document.getElementById('imageContainer');
                    imageContainer.innerHTML = ''; // Clear previous images
                    document.getElementById('imageContainer').innerHTML = ''; // Clear previous image
                    //迴圈
                    for (let pageNumber = 1; pageNumber <= numPages; pageNumber++) {
                        const page = await pdf.getPage(pageNumber);

                        const scale = 2;
                        const viewport = page.getViewport({ scale });

                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;

                        const canvasContext = canvas.getContext('2d');
                        const renderContext = {
                            canvasContext,
                            viewport,
                        };

                        await page.render(renderContext).promise;

                        const image = new Image();
                        image.src = canvas.toDataURL('image/png'); // Convert canvas to PNG image

                         const { createWorker } = Tesseract;
                         //下面著個await很重要，有他才會照頁數輸出
                         await (async () => {
                            const worker = await createWorker({ logger: m => console.log(m), });
                            await worker.loadLanguage('eng+chi_tra');
                            await worker.initialize('eng+chi_tra');
                            const { data: { text } } = await worker.recognize(image.src);

                             const pageNumberText = document.createTextNode('Page ' + pageNumber + text);
                            const paragraph = document.createElement('p');
                            paragraph.className="ahahaa";
                            image.style="display:block; margin:auto;"
                            await paragraph.appendChild(pageNumberText);

                            await document.getElementById('imageContainer').appendChild(image);
                            await document.getElementById('imageContainer').appendChild(paragraph);
                            await worker.terminate();
                        })();
                    }
                    resultDiv.textContent = "辨識完成";
                });
            }
        });
    </script>
</body>

</html>
