<!-- 照片的版本 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            color:rgb(0, 0, 0);
            background-color: rgb(120, 192, 224);
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
        }
        #butt:hover{
            background-color: rgb(252, 223, 166);
        }
        #butt{
            border-radius: 5px;
            cursor: pointer;
            background-color: rgb(255, 211, 232);
            font-size: 90px; 
        }
        .parent {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
    </style>
    <title>take picturesss</title>
</head>
<body>
    <div >
        <p >
            <label id="butt" class="parent" for="pho">手寫拍攝</label>
            <input id="pho" capture="environment" type="file" accept="image/*" style="visibility: hidden;" />
        </p>
        <hr>
        <div class="parent" id="result" style="font-size: 50px; " alt="使用圖片" title="被偵測圖片">請將文字放在畫面正中央</div>
        <hr>
        <img src="" style="display:block; margin:auto;" id="Im_image" width="100%">
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script>
        const input = document.getElementById('pho');
        const butt = document.getElementById('butt');
        const img = document.getElementById('Im_image');
        const resultDiv = document.getElementById('result');
        input.addEventListener('change', handleFilesImage, false);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img_to_bi = new Image();

        butt.addEventListener("touchstart", e => {
        butt.style.backgroundColor="red"
        })

        function handleFilesImage() {
            img.src = ""
            resultDiv.textContent = "文字:處理中...";
            const fileData = this.files;
            const reader = new FileReader();
            reader.readAsDataURL(fileData[0]);
            reader.addEventListener('load', file => {
                img.src = file.target.result;
                img_to_bi.src = file.target.result;
                // 降解
                img_to_bi.onload = function () {
                    resoluti = 550
                    canvas.width = img_to_bi.width;
                    canvas.height = img_to_bi.height;
                    ctx.drawImage(img_to_bi, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    const data = imageData.data;
                    //二值化
                    for (let i = 0; i < data.length; i += 4) {
                        const grayscale = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                        const binaryValue = grayscale > 128 ? 255 : 0;
                        data[i] = data[i + 1] = data[i + 2] = binaryValue;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    const binaryDataURL = canvas.toDataURL('image/png');
                    img_to_bi.src = binaryDataURL
                    img.src = binaryDataURL
                    // Now you can use binaryDataURL as needed, e.g., set it as the src of an img element
                };
                //辨識文字
                const { createWorker } = Tesseract;
                (async () => {
                    const worker = await createWorker({ logger: m => console.log(m), });;
                    await worker.loadLanguage('eng+chi_tra');
                    await worker.initialize('eng+chi_tra');
                    const { data: { text } } = await worker.recognize(img_to_bi.src);
                    resultDiv.textContent = text;
                    console.log(text);
                    await worker.terminate();
                })();
            });
        }
    </script>
</body>
</html>
